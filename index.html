<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>dispatch by noodlehaus</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>dispatch</h1>
        <p>PHP 5.3+ Utility Library</p>

        <p class="view"><a href="https://github.com/noodlehaus/dispatch">View the Project on GitHub <small>noodlehaus/dispatch</small></a></p>


        <ul>
          <li><a href="https://github.com/noodlehaus/dispatch/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/noodlehaus/dispatch/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/noodlehaus/dispatch">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>Dispatch PHP 5.3 Utility Library</h2>

<p>At the very least, <code>dispatch()</code> is a front controller for your web app. It doesn't give you the full MVC setup, but it lets you define url routes and segregate your app logic from your views.</p>

<h3>Requirements</h3>

<ul>
<li>PHP 5.3</li>
<li>
<code>mcrypt</code> extension if you want to use encrypted cookies and wish to use <code>encrypt()</code> and <code>decrypt()</code> functions</li>
<li>
<code>apc</code> extension if you want to use <code>cache()</code> and <code>cache_invalidate()</code>
</li>
</ul><h3>Contributors</h3>

<p>Thanks to the following contributors for helping improve this tool :)</p>

<ul>
<li>Kafene <a href="https://github.com/kafene">kafene</a>
</li>
<li>Martin Angelov <a href="https://github.com/martinaglv">martingalv</a>
</li>
<li>Lars <a href="https://github.com/larsbo">larsbo</a>
</li>
</ul><h3>Related Libraries</h3>

<ul>
<li>
<a href="http://github.com/noodlehaus/dispatch-mongo">disptach-mongo</a> - wrapper for commonly used mongodb functions for dispatch</li>
<li>
<a href="http://github.com/noodlehaus/dispatch-elastic">disptach-elastic</a> - wrapper for commonly used elasticsearch operations for dispatch</li>
</ul><h3>Configuration Variables</h3>

<p>The following functions rely on variables set via <code>config()</code>:</p>

<ul>
<li>
<code>config('debug.log')</code> is used by <code>_log()</code> as the destination log file</li>
<li>
<code>config('debug.enable')</code> dictates if <code>_log()</code> does something or not</li>
<li>
<code>config('views.root')</code> is used by <code>render()</code> and <code>partial()</code>, defaults to <code>./views</code>
</li>
<li>
<code>config('views.layout')</code> is used by <code>render()</code>, defaults to <code>layout</code>
</li>
<li>
<code>config('cookies.secret')</code> is used by <code>encrypt()</code>, <code>decrypt()</code>, <code>set_cookie()</code> and <code>get_cookie()</code>, defaults to an empty string</li>
<li>
<code>config('cookies.flash')</code> is used by <code>flash()</code> for setting messages</li>
<li>
<code>config('site.url')</code> is used by <code>site_url()</code> and <code>site_path()</code>
</li>
<li>
<code>config('source', 'inifile.ini')</code> makes the contents of <code>inifile.ini</code> accessible via <code>config()</code> calls</li>
</ul><h3>Quick and Basic</h3>

<p>A typical PHP app using dispatch() will look like this.</p>

<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// include the library</span>
<span class="k">include</span> <span class="s1">'dispatch.php'</span><span class="p">;</span>

<span class="c1">// define your routes</span>
<span class="nx">get</span><span class="p">(</span><span class="s1">'/greet'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// render a view</span>
    <span class="nx">render</span><span class="p">(</span><span class="s1">'greet-form'</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// post handler</span>
<span class="nx">post</span><span class="p">(</span><span class="s1">'/greet'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="nx">from</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">);</span>
    <span class="c1">// render a view while passing some locals</span>
    <span class="nx">render</span><span class="p">(</span><span class="s1">'greet-show'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">));</span>
<span class="p">});</span>

<span class="c1">// serve your site</span>
<span class="nx">dispatch</span><span class="p">();</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<h3>Route Symbol Filters</h3>

<p>This is taken from ExpressJS. Route filters let you map functions against symbols in your routes. These functions then get executed when those symbols are matched.</p>

<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// preload blog entry whenever a matching route has :blog_id in it</span>
<span class="nx">filter</span><span class="p">(</span><span class="s1">'blog_id'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$blog_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$blog</span> <span class="o">=</span> <span class="nx">Blog</span><span class="o">::</span><span class="na">findOne</span><span class="p">(</span><span class="nv">$blog_id</span><span class="p">);</span>
    <span class="c1">// stash() lets you store stuff for later use (NOT a cache)</span>
    <span class="nx">stash</span><span class="p">(</span><span class="s1">'blog'</span><span class="p">,</span> <span class="nv">$blog</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// here, we have :blog_id in the route, so our preloader gets run</span>
<span class="nx">get</span><span class="p">(</span><span class="s1">'/blogs/:blog_id'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$blog_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// pick up what we got from the stash</span>
    <span class="nv">$blog</span> <span class="o">=</span> <span class="nx">stash</span><span class="p">(</span><span class="s1">'blog'</span><span class="p">);</span>
    <span class="nx">render</span><span class="p">(</span><span class="s1">'blogs/show'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'blog'</span> <span class="o">=&gt;</span> <span class="nv">$blog</span><span class="p">);</span>
<span class="p">});</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<h3>Conditions</h3>

<p>Conditions are basically helper functions. I adopted the name 'conditions' so as to encourage you to use it at the start of your handlers.</p>

<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// require that users are signed in</span>
<span class="nx">condition</span><span class="p">(</span><span class="s1">'signed_in'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">redirect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s1">'/403-forbidden'</span><span class="p">,</span> <span class="o">!</span><span class="nx">stash</span><span class="p">(</span><span class="s1">'user'</span><span class="p">));</span>
<span class="p">});</span>

<span class="c1">// require a valid token when accessing a page</span>
<span class="nx">get</span><span class="p">(</span><span class="s1">'/admin'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">condition</span><span class="p">(</span><span class="s1">'signed_in'</span><span class="p">);</span>
  <span class="nx">render</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">);</span>
<span class="p">});</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<p><em>NOTE:</em> Because of the way conditions are defined, conditions can't have anonymous functions as their first parameter.</p>

<h3>Middleware</h3>

<p>If you have wind up routines that need to be done before handling the request, you can queue them up using the <code>middleware()</code> function.</p>

<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// create a db connection and stash it</span>
<span class="nx">middleware</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="nx">create_connection</span><span class="p">();</span>
    <span class="nx">stash</span><span class="p">(</span><span class="s1">'db'</span><span class="p">,</span> <span class="nv">$db</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// assume that the db connection was stash()ed</span>
<span class="nx">get</span><span class="p">(</span><span class="s1">'/list'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="nx">stash</span><span class="p">(</span><span class="s1">'db'</span><span class="p">);</span>
    <span class="c1">// do stuff with the DB</span>
<span class="p">});</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<h3>Caching via APC</h3>

<p>If you have <code>apc.so</code> enabled, you can make use of dispatch's simple caching functions.</p>

<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// fetch something from the cache (ttl for the cache is 60, based on last parameter)</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// this function is called as a loader if apc doesn't have 'users' in the cache,</span>
  <span class="c1">// whatever it returns gets stored into apc and mapped to the 'users' key</span>
  <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'sheryl'</span><span class="p">,</span> <span class="s1">'addie'</span><span class="p">,</span> <span class="s1">'jaydee'</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">60</span><span class="p">);</span>

<span class="c1">// invalidate our cached keys (users, products, news)</span>
<span class="nx">cache_invalidate</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="s1">'products'</span><span class="p">,</span> <span class="s1">'news'</span><span class="p">);</span>
</pre></div>

<h3>Configurations</h3>

<p>You can make use of ini files for configuration by doing something like <code>config('source', 'myconfig.ini')</code>.
This lets you put configuration settings in ini files instead of making <code>config()</code> calls in your code.</p>

<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// load the contents of my-settings.ini into config()</span>
<span class="nx">config</span><span class="p">(</span><span class="s1">'source'</span><span class="p">,</span> <span class="s1">'my-settings.ini'</span><span class="p">);</span>

<span class="c1">// set a different folder for the views</span>
<span class="nx">config</span><span class="p">(</span><span class="s1">'views.root'</span><span class="p">,</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">'/myviews'</span><span class="p">);</span>

<span class="c1">// get the encryption secret</span>
<span class="nv">$secret</span> <span class="o">=</span> <span class="nx">config</span><span class="p">(</span><span class="s1">'cookies.secret'</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<h3>Utility Functions</h3>

<p>There are a lot of other useful routines in the library. Documentation is still lacking but they're very small and easy to figure out. Read the source for now.</p>

<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// store a config and get it</span>
<span class="nx">config</span><span class="p">(</span><span class="s1">'views.root'</span><span class="p">,</span> <span class="s1">'./views'</span><span class="p">);</span>
<span class="nx">config</span><span class="p">(</span><span class="s1">'views.root'</span><span class="p">);</span> <span class="c1">// returns './views'</span>

<span class="c1">// stash a var and get it (useful for moving stuff between scopes)</span>
<span class="nx">stash</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
<span class="nx">stash</span><span class="p">(</span><span class="s1">'user'</span><span class="p">);</span> <span class="c1">// returns stored $user var</span>

<span class="c1">// redirect with a status code</span>
<span class="nx">redirect</span><span class="p">(</span><span class="mi">302</span><span class="p">,</span> <span class="s1">'/index'</span><span class="p">);</span>

<span class="c1">// redirect if a condition is met</span>
<span class="nx">redirect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s1">'/users'</span><span class="p">,</span> <span class="o">!</span><span class="nv">$authenticated</span><span class="p">);</span>

<span class="c1">// redirect only if func is satisfied</span>
<span class="nx">redirect</span><span class="p">(</span><span class="s1">'/admin'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$auth</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="nv">$auth</span><span class="p">;</span> <span class="p">});</span>

<span class="c1">// redirect only if func is satisfied, and with a diff code</span>
<span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="s1">'/admin'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$auth</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="nv">$auth</span><span class="p">;</span> <span class="p">});</span>

<span class="c1">// send a http error code and print out a message</span>
<span class="nx">error</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s1">'Forbidden'</span><span class="p">);</span>

<span class="c1">// get the current HTTP method or check the current method</span>
<span class="nx">method</span><span class="p">();</span> <span class="c1">// GET, POST, PUT, DELETE</span>
<span class="nx">method</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">);</span> <span class="c1">// true if POST request, false otherwise</span>

<span class="c1">// client's IP</span>
<span class="nx">client_ip</span><span class="p">();</span>

<span class="c1">// get something or a hash from a hash</span>
<span class="nv">$name</span> <span class="o">=</span> <span class="nx">from</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">);</span>
<span class="nv">$user</span> <span class="o">=</span> <span class="nx">from</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">));</span>

<span class="c1">// escape a string</span>
<span class="nx">_h</span><span class="p">(</span><span class="s1">'Marley &amp; Me'</span><span class="p">);</span>

<span class="c1">// url encode</span>
<span class="nx">_u</span><span class="p">(</span><span class="s1">'http://noodlehaus.github.com/dispatch'</span><span class="p">);</span>

<span class="c1">// load a partial using some file and locals</span>
<span class="nv">$html</span> <span class="o">=</span> <span class="nx">partial</span><span class="p">(</span><span class="s1">'users/profile'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'user'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<h2>LICENSE</h2>

<p>MIT</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/noodlehaus">noodlehaus</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>